# 8章: コードを改善する

⏱️ **所要時間**: 実践45分

## 📋 この章の目標

- [ ] 実際にコードレビューを依頼できる
- [ ] レビュー結果を理解して改善できる
- [ ] Before/Afterで品質向上を体感する

---

## 🎯 今回やること

6章で作った **経費精算アプリ** をClaude Codeにレビューしてもらい、改善します。

### 改善する観点
1. セキュリティ
2. パフォーマンス
3. 可読性
4. エラーハンドリング

---

## 🚀 ハンズオン（45分）

### ステップ1: プロジェクトを開く（2分）

```bash
cd expense-tracker
claude
```

6章で作った `index.html` を開きます。

### ステップ2: 全体レビューを依頼（10分）

Claude Codeに以下のように依頼：

```
💬 「index.htmlのコードをレビューしてください。

以下の観点でチェックしてください:
1. セキュリティ（XSS、入力バリデーション）
2. パフォーマンス（DOM操作の最適化）
3. 可読性（変数名、関数名、コメント）
4. エラーハンドリング（try-catch、ユーザーへのフィードバック）
5. ベストプラクティス（モダンなJavaScript記法）

各項目について、具体的な改善提案をお願いします。」
```

**Claude Codeの応答例**:
```
レビュー結果:

【セキュリティ】
⚠️ 問題: innerHTML使用でXSS脆弱性の可能性
場所: 行123
提案: textContentまたはcreateElementを使用

【パフォーマンス】
⚠️ 問題: ループ内でDOM操作が頻繁
場所: 行156-170
提案: DocumentFragmentを使用してまとめて追加

【可読性】
⚠️ 問題: 関数名が不明確
場所: renderList()
提案: renderExpenseList()に変更

...
```

**やること**:
- レビュー結果を読む
- 各指摘の理由を理解する
- 優先順位をつける（セキュリティ > パフォーマンス > 可読性）

### ステップ3: セキュリティ改善（10分）

**指摘1: innerHTML使用**

```
💬 「XSS脆弱性の指摘について、具体的にどう修正すればいいですか？
現在のコードと修正後のコードを見せてください」
```

**修正前**:
```javascript
element.innerHTML = `<div>${userInput}</div>`;
```

**修正後**:
```javascript
const div = document.createElement('div');
div.textContent = userInput;  // 自動エスケープ
element.appendChild(div);
```

**修正を依頼**:
```
💬 「index.htmlのすべてのinnerHTML使用箇所を、
XSS対策済みのコードに修正してください」
```

**指摘2: 入力バリデーション不足**

```
💬 「金額入力のバリデーションを強化してください。
- 負の数を入力できないようにする
- 100万円を超える金額は警告を出す
- 小数点以下は四捨五入する」
```

### ステップ4: パフォーマンス改善（10分）

**指摘: DOM操作の最適化**

```
💬 「経費一覧の描画を最適化してください。
現在、1件ずつDOM追加していますが、
DocumentFragmentを使ってまとめて追加する方式に変更してください」
```

**修正前**:
```javascript
expenses.forEach(expense => {
  const item = createExpenseItem(expense);
  list.appendChild(item);  // 毎回DOM更新
});
```

**修正後**:
```javascript
const fragment = document.createDocumentFragment();
expenses.forEach(expense => {
  const item = createExpenseItem(expense);
  fragment.appendChild(item);  // メモリ上で構築
});
list.appendChild(fragment);  // 1回だけDOM更新
```

**効果測定**:
```
💬 「修正前後でパフォーマンスはどれくらい改善しましたか？」
```

### ステップ5: 可読性改善（8分）

**指摘: 変数名・関数名**

```
💬 「以下の関数名をより明確にしてください:
- calc() → calculateMonthlyTotal()
- update() → updateExpenseList()
- render() → renderExpenseSummary()

また、マジックナンバー（1000, 500など）を
定数として定義してください」
```

**修正例**:
```javascript
// 修正前
if (amount > 1000000) {
  alert('高額です');
}

// 修正後
const MAX_EXPENSE_AMOUNT = 1000000;
const HIGH_AMOUNT_WARNING = '金額が高額です。確認してください。';

if (amount > MAX_EXPENSE_AMOUNT) {
  alert(HIGH_AMOUNT_WARNING);
}
```

**コメント追加**:
```
💬 「主要な関数にJSDocコメントを追加してください。
各関数の目的、引数、戻り値を明記してください」
```

### ステップ6: エラーハンドリング追加（5分）

```
💬 「以下のエラーハンドリングを追加してください:

1. localStorageアクセス失敗時の処理
   - プライベートモードで動作しない場合がある
   - エラー時はメモリ上でのみ動作させる

2. CSV出力失敗時の処理
   - ダウンロードできない場合の代替手段
   - エラーメッセージの表示

3. 日付パース失敗時の処理
   - 不正な日付形式の検出
   - デフォルト値（今日）を使用」
```

**実装例**:
```javascript
// localStorageのエラーハンドリング
function saveExpenses(expenses) {
  try {
    localStorage.setItem('expenses', JSON.stringify(expenses));
  } catch (error) {
    console.error('保存エラー:', error);
    alert('データを保存できませんでした。ブラウザの設定を確認してください。');
    // メモリ上のみで動作を継続
  }
}
```

---

## 📊 Before / After 比較

### セキュリティ

| 項目 | Before | After |
|------|--------|-------|
| XSS対策 | ❌ なし | ✅ 全箇所対策済み |
| 入力チェック | ⚠️ 基本のみ | ✅ 厳密なバリデーション |

### パフォーマンス

| 項目 | Before | After |
|------|--------|-------|
| 100件描画 | 150ms | 45ms（3倍高速） |
| DOM操作 | 100回 | 1回 |

### 可読性

| 項目 | Before | After |
|------|--------|-------|
| 関数名 | 不明確 | 明確で説明的 |
| コメント | なし | JSDoc完備 |
| マジックナンバー | あり | 定数化済み |

### エラー処理

| 項目 | Before | After |
|------|--------|-------|
| localStorage | ❌ なし | ✅ try-catch |
| CSV出力 | ❌ なし | ✅ フォールバック |
| 日付処理 | ❌ なし | ✅ デフォルト値 |

---

## 💼 実務での効果

### ケース1: 副業案件での活用

```
状況: クライアントから「バグが多い」と指摘

対応:
1. 全コードをAIレビュー
2. 指摘された問題を全て修正
3. 再納品

結果:
- バグ報告ゼロ
- クライアント満足度向上
- 追加案件の受注
```

### ケース2: コードレビュー時間短縮

```
従来:
自分で書く → レビュー待ち（1-2日） → 修正 → 再レビュー

改善後:
自分で書く → AIレビュー（即座） → 修正 → 人間レビュー

効果:
- レビューサイクルが2日→2時間に短縮
- レビュー指摘が80%減少
- チーム全体の生産性20%向上
```

### ケース3: スキルアップ

```
レビューを受けるたびに:
- 「なぜこの書き方が悪いのか」理解
- 「どう書くべきか」学習
- 次回から同じミスをしない

3ヶ月後:
- レビュー指摘が激減
- コード品質が大幅向上
- チーム内で信頼されるエンジニアに
```

---

## ✅ 完了チェック

この章を終えたら、以下を確認してください：

- [ ] コードレビューを依頼できた
- [ ] セキュリティ、パフォーマンス、可読性を改善できた
- [ ] エラーハンドリングを追加できた
- [ ] Before/Afterで品質向上を体感できた

**すべてチェックできたら、9章へ進みましょう！**

---

## 💡 よくある質問

**Q: レビューの指摘が多すぎて対応しきれない**
A: 優先順位をつけましょう。セキュリティ > パフォーマンス > 可読性の順で対応。すべてを一度に直す必要はありません。

**Q: 指摘内容が理解できない**
A: Claude Codeに「もっと詳しく説明してください」「具体例を見せてください」と聞きましょう。

**Q: レビュー結果を記録しておきたい**
A: レビュー結果をMarkdownファイルに保存して、後で見返せるようにしましょう。

---

## 🔗 次のステップ

次は **9章: テスト自動生成** で、コードの品質をさらに高めるテストの書き方を学びます！
